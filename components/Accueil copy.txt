import React, { useEffect, useState } from "react";
import { Checkbox } from 'react-native-paper';
import { RouteProp } from "@react-navigation/native";
import { Picker } from '@react-native-picker/picker';
import { NativeStackNavigationProp } from "@react-navigation/native-stack";
import { useNavigation, useIsFocused } from "@react-navigation/native";
import { Alert, Button, ScrollView, StyleSheet, Text, TextInput, View } from 'react-native';
import useFetch from "../hooks/useFetch";
import useLocalStorage from "../hooks/AsyncStorage";
import { Boat, BoatRequest, user } from "../types/UserType.types"; // corrige l'import selon ton fichier
type RootStackParamList = {
  Login: undefined;
  AccueilHome: {
    userName?: string;
    password?: string;
    boatList?: Boat[];
  };
  UpdateBoat: { boatid: string };
  Autresnavigations: { idBoat: string };
};

type AccueilRouteProp = RouteProp<RootStackParamList, "AccueilHome">;

export default function Accueil({ route }: { route: AccueilRouteProp }) {
  const navigation = useNavigation<NativeStackNavigationProp<RootStackParamList>>();
  const { userName = "", password = "", boatList = [] } = route.params || {};

  const [name, setName] = useState("");
  const [goldCargo, setGoldCargo] = useState("");
  const [captain, setCaptain] = useState("");
  const [status, setStatus] = useState<Boat["status"]>("docked");
  const [crewSize, setCrewSize] = useState("");
  const [boatListe, setBoatList] = useState<Boat[]>(boatList || []);
  const [stateAddOrDeleteBoat, setStateAddOrDeleteBoat] = useState(false);
  const [selectedBoats, setSelectedBoats] = useState<Boat[]>([]);
  const [destination, setDestination] = useState("");
  const [nombreEquipage, setNombreEquipage] = useState<string>("");
  const [nombreTresor, setNombreTresor] = useState<string>("");
  const [nombreOr, setNombreOr] = useState<string>("");
  const [ports, setPorts] = useState<string[]>([]);
  const [isAdmin, setIsAdmin] = useState<boolean>(false); // pour gÃ©rer les droits admin

  const { POST, DELETE, GET } = useFetch();
  const tokenStorage = useLocalStorage<string>("authToken");
  const isFocused = useIsFocused();

  const getToken = async (): Promise<string | null> => await tokenStorage.getItem();

  useEffect(() => {
    const fetchBoats = async () => {
      const token = await getToken();
      const listboats = await GET<Boat[]>("/boats", { Authorization: `Bearer ${token}` });
      setBoatList(listboats || []);
    };

    if (isFocused) fetchBoats();
  }, [isFocused, stateAddOrDeleteBoat]);

  const handleSubmit = async () => {
    if (!name || !goldCargo || !captain || !crewSize) {
      Alert.alert("Erreur", "Veuillez remplir tous les champs du formulaire !");
      return;
    }

    try {
      const token = await getToken();
      const newBoat: BoatRequest = {
        name,
        goldCargo: parseInt(goldCargo, 10),
        captain,
        status,
        crewSize: parseInt(crewSize, 10),
      };
      await POST<BoatRequest>("/boat", newBoat, { Authorization: `Bearer ${token}` });
      Alert.alert("SuccÃ¨s", "Bateau ajoutÃ© avec succÃ¨s !");
      setStateAddOrDeleteBoat(!stateAddOrDeleteBoat);
    } catch (error) {
      console.error("Erreur lors de l'ajout du bateau :", error);
    }
  };

  const toggleSelectBoat = (id: string) => {
    setSelectedBoats((prev) =>
      prev.includes(id) ? prev.filter((boatId) => boatId !== id) : [...prev, id]
    );
  };

  const handleDelete = async (id: string) => {
    try {
      const token = await getToken();
      await DELETE(`/boat/${id}`, { Authorization: `Bearer ${token}` });
      Alert.alert("SuccÃ¨s", "Bateau supprimÃ© avec succÃ¨s !");
      setStateAddOrDeleteBoat(!stateAddOrDeleteBoat);
    } catch (error) {
      console.error("Erreur lors de la suppression :", error);
    }
  };

  const handleUpdate = () => {
    navigation.navigate("UpdateBoat", { boatid: id });
  };
 const getToken = async (): Promise<string | null> => {
    const storedToken = await tokenStorage.getItem();
    return storedToken;
  };

  // RÃ©cupÃ©rer les ports disponibles
  const getPorts = async () => {
    try {
      const token = await getToken();
      const portsList = await GET<string[]>("/getAvailablePorts", {
        Authorization: `Bearer ${token}`,
      });
      setPorts(portsList || []);
    } catch (error) {
      console.error("Erreur lors de la rÃ©cupÃ©ration des ports :", error);
    }
  };
  const handleAddequipage = () => {
       const token = await getToken();
      await POST(`/AjouterEquipage/${encodeURIComponent(selectedBoats[0].id)}}`, {}, {
        Authorization: `Bearer ${token}`,
      });
  }
  const handleDeleteEquipage = () => {
 const token = await getToken();
      await POST(`/RetirerEquipage/${encodeURIComponent(selectedBoats[0].id)}}`, {}, {
        Authorization: `Bearer ${token}`,
      });
  }
    const handleAddTresor = () => {
       const token = await getToken();
      await POST(`/AjouterTresor/${encodeURIComponent(selectedBoats[0].id)}/}`, {}, {
        Authorization: `Bearer ${token}`,
      });
  }
  const handleDeleteTresor = () => {
 const token = await getToken();
      await POST(`/supprimerTresor/${encodeURIComponent(selectedBoats[0].id)}/}`, {}, {
        Authorization: `Bearer ${token}`,
      });
  }
  const handleNavigate = () => {
    try {
      for (const idBoat of selectedBoats) {
        navigateBoat(idBoat);
      }
    } catch (error) {
      console.error("Erreur lors de la navigation des bateaux :", error);
    }
  };
const navigateBoat = async (idBoat: string) => {
    if (!idBoat) {
      alert("Veuillez remplir tous les champs !");
      return;
      const token = await getToken();
      await POST(`/sailToPort/${encodeURIComponent(idBoat)}/${encodeURIComponent(destination)}`, {}, {
        Authorization: `Bearer ${token}`,
      });
      alert(`Bateau ${idBoat} envoyÃ© vers ${destination} !`);
         navigation.goBack(); 
    } catch (error) {
      console.error("Erreur lors de l'envoi du bateau :", error);
      alert("Ã‰chec de l'envoi du bateau. VÃ©rifiez la console pour plus d'infos.");
         navigation.goBack(); 
    }
    }
  const handleDeleteSelected = () => {
    selectedBoats.forEach(handleDelete);
    setSelectedBoats([]);
  };

  const handleTransfer = async () => {
    if (!nombreOr || selectedBoats.length < 2) {
      Alert.alert("Erreur", "Veuillez remplir tous les champs !");
      return;
    }
    try {
      const token = await getToken();
      await POST(`/transferGold`, {
        amount: parseInt(nombreOr, 10),
        fromBoatId: selectedBoats[0],
        toBoatId: selectedBoats[1],
      }, { Authorization: `Bearer ${token}` });
      Alert.alert("SuccÃ¨s", `Transfert de ${nombreOr} or effectuÃ© !`);
    } catch (error) {
      console.error("Erreur lors du transfert :", error);
    }
  };

  const handleLogout = async () => {
    try {
      const response = await POST<user, { token: string }>("/logout", { username: userName, password });
      if (response?.token) await tokenStorage.removeItem();
      navigation.navigate("Login");
    } catch (error) {
      console.error("Erreur logout :", error);
    }
  };

  return (
    <ScrollView contentContainerStyle={styles.container}>
      <Text style={styles.title}>Bienvenue {userName} ðŸŽ‰</Text>
      <Text style={styles.subtext}>Nombre de bateaux : {boatListe.length}</Text>

      {boatListe.map((boat) => (
        <View key={boat.id} style={styles.boatContainer}>
          <View style={styles.boatHeader}>
            <Text style={styles.subtext}>{boat.name}</Text>
            <Checkbox
              status={selectedBoats.includes(boat.id) ? "checked" : "unchecked"}
              onPress={() => toggleSelectBoat(boat.id)}
            />
          </View>
          <Text style={styles.subtext}>Statut: {boat.status}</Text>
          <Text style={styles.subtext}>Capitaine: {boat.captain}</Text>
          <Text style={styles.subtext}>Or: {boat.goldCargo}</Text>
          <Text style={styles.subtext}>Ã‰quipage: {boat.crewSize}</Text>
          <Button title="Supprimer" onPress={() => handleDelete(boat.id)} />
          <Button title="Modifier" onPress={() => handleUpdate()} />
          
        </View>
      ))}

      {selectedBoats.length > 0 && (
        <Button
          title={`Supprimer ${selectedBoats.length} bateau(x) sÃ©lectionnÃ©(s)`}
          onPress={handleDeleteSelected}
        />
      )}
     {/* Partie pour un pirate normal */}
{!isAdmin && selectedBoats.length > 0 && (
  <>
    <Text>Pour naviguer vers une destination, sÃ©lectionnez un bateau et appuyez sur "Naviguer"</Text>
    <TextInput
      placeholder="Port"
      value={destination}
      onChangeText={setDestination}
      style={styles.input}
    />
    <Button title="Naviguer" onPress={handleNavigate} />

    <Text>Ajouter ou retirer un membre de l'Ã©quipage</Text>
    <TextInput
      placeholder="Nombre d'Ã©quipage"
      value={nombreEquipage}
      onChangeText={setNombreEquipage}
      style={styles.input}
      keyboardType="numeric"
    />
    <Button title="+" onPress={handleAddequipage} />
    <Button title="-" onPress={handleDeleteEquipage} />

    <Text>Ajouter ou retirer de l'or</Text>
    <TextInput
      placeholder="Nombre d'or"
      value={nombreOr}
      onChangeText={setNombreOr}
      style={styles.input}
      keyboardType="numeric"
    />
    <Button title="+" onPress={handleAddTresor} />
    <Button title="-" onPress={handleDeleteTresor} />
  </>
)}

{/* Partie pour un amiral pirate */}
{isAdmin && (
  <>
    <Text style={styles.title}>Formulaire Bateau</Text>
    <TextInput
      placeholder="Nom du bateau"
      value={name}
      onChangeText={setName}
      style={styles.input}
    />
    <TextInput
      placeholder="Capitaine"
      value={captain}
      onChangeText={setCaptain}
      style={styles.input}
    />
    <TextInput
      placeholder="Or dans la cargaison"
      value={goldCargo}
      onChangeText={setGoldCargo}
      keyboardType="numeric"
      style={styles.input}
    />
    <TextInput
      placeholder="Taille de l'Ã©quipage"
      value={crewSize}
      onChangeText={setCrewSize}
      keyboardType="numeric"
      style={styles.input}
    />

    <Text style={{ marginBottom: 5 }}>Statut :</Text>
    <Picker
      selectedValue={status}
      onValueChange={(value: Boat["status"]) => setStatus(value)}
      style={styles.input}
    >
      <Picker.Item label="Docked" value="docked" />
      <Picker.Item label="Sailing" value="sailing" />
      <Picker.Item label="Looking For A Fight" value="lookingForAFight" />
    </Picker>

    <Button title="Ajouter le bateau" onPress={handleSubmit} />

    <Text style={styles.title}>Transfert d'or entre bateaux</Text>
    <TextInput
      placeholder="Montant Ã  transfÃ©rer"
      value={nombreOr}
      onChangeText={setNombreOr}
      keyboardType="numeric"
      style={styles.input}
    />
    <Button title="TransfÃ©rer" onPress={handleTransfer} />
  </>
)}




  

      <Button title="Se dÃ©connecter" onPress={handleLogout} />
    </ScrollView>
  );
}

const styles = StyleSheet.create({
  container: { flex: 1, justifyContent: "center", alignItems: "center", padding: 20, backgroundColor: "#f0f8ff" },
  title: { fontSize: 22, fontWeight: "bold", marginBottom: 10, color: "#1e3a8a" },
  subtext: { fontSize: 16, color: "#555", marginBottom: 5 },
  input: { width: "100%", borderWidth: 1, borderColor: "#ccc", borderRadius: 8, padding: 10, marginBottom: 15, backgroundColor: "#fff" },
  boatContainer: { marginTop: 10, borderWidth: 1, padding: 10, borderRadius: 8, width: "100%" },
  boatHeader: { flexDirection: "row", justifyContent: "space-between", alignItems: "center" },
});
